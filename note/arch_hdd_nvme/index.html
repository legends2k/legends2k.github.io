<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Move Linux b/w Drives &#183; </title><meta name=description content="From HDD to SSD"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.130.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/images/pencil-square-o.svg sizes=any type=image/svg+xml><meta property="og:title" content="Move Linux b/w Drives"><meta property="og:description" content="From HDD to SSD"><meta property="og:type" content="article"><meta property="og:url" content="https://legends2k.github.io/note/arch_hdd_nvme/"><link rel=stylesheet href=https://legends2k.github.io/dist/styles.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.5.0/hint.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css></head><body><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><a class="button-square hint--top hint--rounded hint--bounce" aria-label=Home title=Home href=https://legends2k.github.io/ rel=me><i class="fa fa-home"></i>
</a><a class="button-square hint--top hint--rounded hint--bounce" aria-label="RSS Feed" title="RSS Feed" href=https://legends2k.github.io/index.xml><i class="fa fa-rss"></i></a>
<a class="button-square hint--top hint--rounded hint--bounce" aria-label=Github title=Github href=https://github.com/legends2k rel=me><i class="fa fa-github-alt"></i>
</a><a class="button-square hint--top hint--rounded hint--bounce" aria-label=Bitbucket title=Bitbucket href=https://bitbucket.org/rmsundaram rel=me><i class="fa fa-bitbucket"></i>
</a><a class="button-square hint--top hint--rounded hint--bounce" aria-label="Stack Overflow" title="Stack Overflow" href=https://stackoverflow.com/users/183120/legends2k rel=me><i class="fa fa-stack-overflow"></i>
</a><a class="button-square hint--top hint--rounded hint--bounce" aria-label=LinkedIn title=LinkedIn href=https://in.linkedin.com/pub/sundaram-ramaswamy/24/b20/1a0 rel=me><i class="fa fa-linkedin"></i>
</a><a class="button-square hint--top hint--rounded hint--bounce" aria-label=Flickr title=Flickr href=https://flickr.com/photos/legends2k rel=me><i class="fa fa-flickr"></i>
</a><a class="button-square hint--top hint--rounded hint--bounce" aria-label=Email title=Email href=mailto:legends2k@yahoo.com><i class="fa fa-envelope"></i></a></div><ul class=site-nav><li class=site-nav-item><a href=/post/>Posts</a></li><li class=site-nav-item><a href=/note/>Notes</a></li><li class=site-nav-item><a href=/archive/>All Posts</a></li><li class=site-nav-item><a href=/projects/>Projects</a></li><li class=site-nav-item><a href=/about/>About</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Move Linux b/w Drives</h1><p class=post-description itemprop=description>From HDD to SSD</p><p class=post-date>Published <time datetime=2023-12-18 itemprop=datePublished>Dec 18, 2023</time>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=# itemprop=url rel=author></a></span></span><span class=post-update-date>Updated <time datetime=2023-12-18 itemprop=datePublished>Mar 20, 2024</time></span></p><aside><h1>Contents</h1><nav id=TableOfContents><ol><li><a href=#setup-nvme-lba>Setup NVMe LBA</a></li><li><a href=#fixed-partitioning>Fixed Partitioning</a><ol><li><a href=#format-esp>Format ESP</a></li></ol></li><li><a href=#logical-partitioning>Logical Partitioning</a><ol><li><a href=#file-system>File System</a></li></ol></li><li><a href=#copy-data-to-ssd>Copy Data to SSD</a></li><li><a href=#fix-etcfstab>Fix <code>/etc/fstab</code></a></li><li><a href=#reinstall-grub>Reinstall GRUB</a></li><li><a href=#appendix-a-remove-stale-devmapper>Appendix A: Remove Stale <code>/dev/mapper/*</code></a></li><li><a href=#references>References</a></li><li><a href=#see-also>See Also</a></li></ol></nav></aside></header><div class="post-content clearfix" itemprop=articleBody><p>Flash memories comes in different forms and use different interfaces to connect. Pen drives use <a href=https://en.wikipedia.org/wiki/Flash_memory>flash memory</a> while
SSDs use <a href=https://en.wikipedia.org/wiki/Solid-state_storage>solid state storage</a>. SSDs can be interfaced with your <em>mobo</em><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> either through SATA or PCIe; M.2
is actually a form factor (standard stating about the size and form of such drives which are small and rectangular;
looks like RAM modules compared to the 2.5 inch drives), connecting to your mobo via PCIe with the logical interface options of AHCI (legacy) or NVMe. So you might encounter
M.2 drives connecting over AHCI (typically slower); check if your M.2 drives interface over NVMe if you want speed. For disambiguation of these terms <a href=https://www.pcworld.com/article/558324/nvme-vs-m-2-vs-sata-ssd-whats-the-difference.html>refer</a>.</p><p>I recently bought a 500 GB NVMe drive for my AMD Ryzen 5600 desktop. Thanks to the spinning 3.5 inch HDD, which was
audibly grinding most of the time, the machine didn’t realize its full potential. Now I love the software setup on this
machine, with Arch at the helm and everything setup the way I want.</p><p>This is a write-up on moving the OS setup from the HDD (with logical volumes of LVM2 <a href=/note/lvm_resize/>for flexibility</a>) to SSD.</p><h1 id=setup-nvme-lba>Setup NVMe LBA</h1><p>Install NVMe CLI (<code>nvme</code>) for setting the optimal <a href=https://en.wikipedia.org/wiki/Logical_block_addressing>LBA</a> size:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>yay</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>S</span> <span style=color:#ff79c6>--</span><span style=color:#8be9fd;font-style:italic>needed</span> <span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>cli</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nvme</span> <span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>ns</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>H</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1</span> <span style=color:#ff79c6>|</span> <span style=color:#8be9fd;font-style:italic>grep</span> <span style=color:#f1fa8c>&#34;Relative Performance&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LBA</span> <span style=color:#8be9fd;font-style:italic>Format</span>  <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>Metadata</span> <span style=color:#8be9fd;font-style:italic>Size:</span> <span style=color:#bd93f9>0</span>   <span style=color:#8be9fd;font-style:italic>bytes</span> <span style=color:#ff79c6>-</span> <span style=color:#8be9fd;font-style:italic>Data</span> <span style=color:#8be9fd;font-style:italic>Size:</span> <span style=color:#bd93f9>512</span> <span style=color:#8be9fd;font-style:italic>bytes</span> <span style=color:#ff79c6>-</span> <span style=color:#8be9fd;font-style:italic>Relative</span> <span style=color:#8be9fd;font-style:italic>Performance:</span> <span style=color:#bd93f9>0</span><span style=color:#8be9fd;font-style:italic>x1</span> <span style=color:#8be9fd;font-style:italic>Better</span> (<span style=color:#8be9fd;font-style:italic>in</span> <span style=color:#8be9fd;font-style:italic>use</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>LBA</span> <span style=color:#8be9fd;font-style:italic>Format</span>  <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>Metadata</span> <span style=color:#8be9fd;font-style:italic>Size:</span> <span style=color:#bd93f9>0</span>   <span style=color:#8be9fd;font-style:italic>bytes</span> <span style=color:#ff79c6>-</span> <span style=color:#8be9fd;font-style:italic>Data</span> <span style=color:#8be9fd;font-style:italic>Size:</span> <span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>bytes</span> <span style=color:#ff79c6>-</span> <span style=color:#8be9fd;font-style:italic>Relative</span> <span style=color:#8be9fd;font-style:italic>Performance:</span> <span style=color:#bd93f9>0</span> <span style=color:#8be9fd;font-style:italic>Best</span></span></span></code></pre></div><p>Looks like the LBA format isn’t set for best performance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nvme</span> <span style=color:#8be9fd;font-style:italic>format</span> <span style=color:#ff79c6>--</span><span style=color:#8be9fd;font-style:italic>lbaf</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>You</span> <span style=color:#8be9fd;font-style:italic>are</span> <span style=color:#8be9fd;font-style:italic>about</span> <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>format</span> <span style=color:#8be9fd;font-style:italic>nvme0n1</span>, <span style=color:#8be9fd;font-style:italic>namespace</span> <span style=color:#bd93f9>0</span><span style=color:#8be9fd;font-style:italic>xffffffff</span>(<span style=color:#8be9fd;font-style:italic>ALL</span> <span style=color:#8be9fd;font-style:italic>namespaces</span>)<span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>WARNING:</span> <span style=color:#8be9fd;font-style:italic>Format</span> <span style=color:#8be9fd;font-style:italic>may</span> <span style=color:#8be9fd;font-style:italic>irrevocably</span> <span style=color:#8be9fd;font-style:italic>delete</span> <span style=color:#8be9fd;font-style:italic>this</span> <span style=color:#8be9fd;font-style:italic>device</span><span style=color:#6272a4>&#39;s data.</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>You</span> <span style=color:#8be9fd;font-style:italic>have</span> <span style=color:#bd93f9>10</span> <span style=color:#8be9fd;font-style:italic>seconds</span> <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>press</span> <span style=color:#8be9fd;font-style:italic>Ctrl</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>C</span> <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>cancel</span> <span style=color:#8be9fd;font-style:italic>this</span> <span style=color:#8be9fd;font-style:italic>operation</span><span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Use</span> <span style=color:#8be9fd;font-style:italic>the</span> <span style=color:#8be9fd;font-style:italic>force</span> [<span style=color:#ff79c6>--</span><span style=color:#8be9fd;font-style:italic>force</span>] <span style=color:#8be9fd;font-style:italic>option</span> <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>suppress</span> <span style=color:#8be9fd;font-style:italic>this</span> <span style=color:#8be9fd;font-style:italic>warning</span><span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Sending</span> <span style=color:#8be9fd;font-style:italic>format</span> <span style=color:#8be9fd;font-style:italic>operation</span> <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Success</span> <span style=color:#8be9fd;font-style:italic>formatting</span> <span style=color:#8be9fd;font-style:italic>namespace:</span><span style=color:#8be9fd;font-style:italic>ffffffff</span></span></span></code></pre></div><p>This fixed the LBA for best performance. <code>nvme</code> has a bunch of other useful options; try</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nvme</span> <span style=color:#8be9fd;font-style:italic>list</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nvme</span> <span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>ctrl</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>H</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nvme</span> <span style=color:#8be9fd;font-style:italic>smart</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>log</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nvme</span> <span style=color:#8be9fd;font-style:italic>fw</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>log</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0</span></span></span></code></pre></div><h1 id=fixed-partitioning>Fixed Partitioning</h1><p>EFI needs its own partition (ESP) for at least 512 MiB <a href=#references>[3]</a>. The rest is made into one partition; note the
types:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Disk</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1:</span> <span style=color:#bd93f9>465.76</span> <span style=color:#8be9fd;font-style:italic>GiB</span>, <span style=color:#bd93f9>500107862016</span> <span style=color:#8be9fd;font-style:italic>bytes</span>, <span style=color:#bd93f9>122096646</span> <span style=color:#8be9fd;font-style:italic>sectors</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Disk</span> <span style=color:#8be9fd;font-style:italic>model:</span> <span style=color:#8be9fd;font-style:italic>CT500P3SSD8</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Units:</span> <span style=color:#8be9fd;font-style:italic>sectors</span> <span style=color:#8be9fd;font-style:italic>of</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>*</span> <span style=color:#8be9fd;font-style:italic>4096</span> <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>bytes</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Sector</span> <span style=color:#8be9fd;font-style:italic>size</span> (<span style=color:#8be9fd;font-style:italic>logical</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>physical</span>)<span style=color:#ff79c6>:</span> <span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>bytes</span> <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>bytes</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>I</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>O</span> <span style=color:#8be9fd;font-style:italic>size</span> (<span style=color:#8be9fd;font-style:italic>minimum</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>optimal</span>)<span style=color:#ff79c6>:</span> <span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>bytes</span> <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>bytes</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Disklabel</span> <span style=color:#8be9fd;font-style:italic>type:</span> <span style=color:#8be9fd;font-style:italic>gpt</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Disk</span> <span style=color:#8be9fd;font-style:italic>identifier:</span> <span style=color:#8be9fd;font-style:italic>C95F77F1</span><span style=color:#bd93f9>-0464-4676-8</span><span style=color:#8be9fd;font-style:italic>BE3</span><span style=color:#bd93f9>-97325</span><span style=color:#8be9fd;font-style:italic>DEA12A1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Device</span>          <span style=color:#8be9fd;font-style:italic>Start</span>       <span style=color:#8be9fd;font-style:italic>End</span>   <span style=color:#8be9fd;font-style:italic>Sectors</span>   <span style=color:#8be9fd;font-style:italic>Size</span> <span style=color:#8be9fd;font-style:italic>Type</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p1</span>    <span style=color:#bd93f9>256</span>    <span style=color:#bd93f9>131327</span>    <span style=color:#bd93f9>131072</span>   <span style=color:#bd93f9>512</span><span style=color:#8be9fd;font-style:italic>M</span> <span style=color:#8be9fd;font-style:italic>EFI</span> <span style=color:#8be9fd;font-style:italic>System</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p2</span> <span style=color:#bd93f9>131328</span> <span style=color:#bd93f9>122096639</span> <span style=color:#bd93f9>121965312</span> <span style=color:#bd93f9>465.3</span><span style=color:#8be9fd;font-style:italic>G</span> <span style=color:#8be9fd;font-style:italic>Linux</span> <span style=color:#8be9fd;font-style:italic>LVM</span></span></span></code></pre></div><h2 id=format-esp>Format ESP</h2><p>Ensure that ESP is FAT32 for wider recognition; logical sector size is 4096 as LBA is too; cluster size couldn’t be any
larger than 1.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>sudo</span> <span style=color:#8be9fd;font-style:italic>mkfs</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd;font-style:italic>vfat</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>F</span> <span style=color:#bd93f9>32</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>S</span> <span style=color:#bd93f9>4096</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>s</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>v</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>n</span> <span style=color:#8be9fd;font-style:italic>EFI</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mkfs</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd;font-style:italic>fat</span> <span style=color:#bd93f9>4.2</span> (<span style=color:#bd93f9>2021-01-31</span>)
</span></span><span style=display:flex><span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p1</span> <span style=color:#8be9fd;font-style:italic>has</span> <span style=color:#bd93f9>64</span> <span style=color:#8be9fd;font-style:italic>heads</span> <span style=color:#8be9fd;font-style:italic>and</span> <span style=color:#bd93f9>32</span> <span style=color:#8be9fd;font-style:italic>sectors</span> <span style=color:#8be9fd;font-style:italic>per</span> <span style=color:#8be9fd;font-style:italic>track</span>,
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>hidden</span> <span style=color:#8be9fd;font-style:italic>sectors</span> <span style=color:#bd93f9>0</span><span style=color:#8be9fd;font-style:italic>x0800</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>logical</span> <span style=color:#8be9fd;font-style:italic>sector</span> <span style=color:#8be9fd;font-style:italic>size</span> <span style=color:#8be9fd;font-style:italic>is</span> <span style=color:#bd93f9>4096</span>,
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>using</span> <span style=color:#bd93f9>0</span><span style=color:#8be9fd;font-style:italic>xf8</span> <span style=color:#8be9fd;font-style:italic>media</span> <span style=color:#8be9fd;font-style:italic>descriptor</span>, <span style=color:#8be9fd;font-style:italic>with</span> <span style=color:#bd93f9>131072</span> <span style=color:#8be9fd;font-style:italic>sectors</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>drive</span> <span style=color:#8be9fd;font-style:italic>number</span> <span style=color:#bd93f9>0</span><span style=color:#8be9fd;font-style:italic>x80</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>filesystem</span> <span style=color:#8be9fd;font-style:italic>has</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>32</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>bit</span> <span style=color:#8be9fd;font-style:italic>FATs</span> <span style=color:#8be9fd;font-style:italic>and</span> <span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>sector</span> <span style=color:#8be9fd;font-style:italic>per</span> <span style=color:#8be9fd;font-style:italic>cluster</span><span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>FAT</span> <span style=color:#8be9fd;font-style:italic>size</span> <span style=color:#8be9fd;font-style:italic>is</span> <span style=color:#bd93f9>128</span> <span style=color:#8be9fd;font-style:italic>sectors</span>, <span style=color:#8be9fd;font-style:italic>and</span> <span style=color:#8be9fd;font-style:italic>provides</span> <span style=color:#bd93f9>130784</span> <span style=color:#8be9fd;font-style:italic>clusters</span><span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>There</span> <span style=color:#8be9fd;font-style:italic>are</span> <span style=color:#bd93f9>32</span> <span style=color:#8be9fd;font-style:italic>reserved</span> <span style=color:#8be9fd;font-style:italic>sectors</span><span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>Volume</span> <span style=color:#8be9fd;font-style:italic>ID</span> <span style=color:#8be9fd;font-style:italic>is</span> <span style=color:#bd93f9>387</span><span style=color:#8be9fd;font-style:italic>acba5</span>, <span style=color:#8be9fd;font-style:italic>volume</span> <span style=color:#8be9fd;font-style:italic>label</span> <span style=color:#8be9fd;font-style:italic>EFI</span><span style=color:#ff79c6>.</span></span></span></code></pre></div><p>Formatting the <em>Linux LVM</em> partition is redundant as we’ll make logical volumes on it and anyway format them later.</p><h1 id=logical-partitioning>Logical Partitioning</h1><p>Usual drill: create physcial volume (PV), volume group (VG) and logical volumes (LV) under VG. For this case PV is just
the NVMe device and there’s just going to be one VG; refer <a href=#references>[4]</a> for various other configurations.</p><p>As per <a href=#references>[5]</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>pvcreate</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p2</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>vgcreate</span> <span style=color:#8be9fd;font-style:italic>nvme</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p2</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>lvcreate</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>L</span> <span style=color:#bd93f9>40</span><span style=color:#8be9fd;font-style:italic>G</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>n</span> <span style=color:#8be9fd;font-style:italic>root</span> <span style=color:#8be9fd;font-style:italic>nvme</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>lvcreate</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>L</span> <span style=color:#bd93f9>16</span><span style=color:#8be9fd;font-style:italic>G</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>n</span> <span style=color:#8be9fd;font-style:italic>var</span> <span style=color:#8be9fd;font-style:italic>nvme</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>lvcreate</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>L</span> <span style=color:#bd93f9>16</span><span style=color:#8be9fd;font-style:italic>G</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>n</span> <span style=color:#8be9fd;font-style:italic>home</span> <span style=color:#8be9fd;font-style:italic>nvme</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>lvcreate</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>L</span> <span style=color:#bd93f9>200</span><span style=color:#8be9fd;font-style:italic>G</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>n</span> <span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#8be9fd;font-style:italic>nvme</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>lvcreate</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>L</span> <span style=color:#bd93f9>197896</span><span style=color:#8be9fd;font-style:italic>M</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>n</span> <span style=color:#8be9fd;font-style:italic>media</span> <span style=color:#8be9fd;font-style:italic>nvme</span></span></span></code></pre></div><p>Use <code>pvs</code>, <code>vgs</code> and <code>lvs</code> for short, and <code>pvdisplay</code>, <code>vgdisplay</code> and <code>lvdisplay</code> for detailed view of the layout.</p><p><code>lsblk -f</code> shows the final partitioning scheme</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nvme0n1</span>
</span></span><span style=display:flex><span>├─<span style=color:#8be9fd;font-style:italic>nvme0n1p1</span>    <span style=color:#8be9fd;font-style:italic>vfat</span>        <span style=color:#8be9fd;font-style:italic>FAT32</span>    <span style=color:#8be9fd;font-style:italic>EFI</span>
</span></span><span style=display:flex><span>└─<span style=color:#8be9fd;font-style:italic>nvme0n1p2</span>    <span style=color:#8be9fd;font-style:italic>LVM2_member</span> <span style=color:#8be9fd;font-style:italic>LVM2</span> <span style=color:#bd93f9>001</span>
</span></span><span style=display:flex><span>  ├─<span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>root</span>
</span></span><span style=display:flex><span>  ├─<span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>var</span>
</span></span><span style=display:flex><span>  ├─<span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>home</span>
</span></span><span style=display:flex><span>  ├─<span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>data</span>
</span></span><span style=display:flex><span>  └─<span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>media</span></span></span></code></pre></div><h2 id=file-system>File System</h2><p>Format logical volumes individually with required filesystems. Ensure that reserved space isn’t too much:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Set</span> <span style=color:#8be9fd;font-style:italic>directly</span> <span style=color:#8be9fd;font-style:italic>while</span> <span style=color:#8be9fd;font-style:italic>creating</span> (<span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#bd93f9>1</span><span style=color:#ff79c6>%</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mkfs</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd;font-style:italic>ext4</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>m</span> <span style=color:#bd93f9>1</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>media</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Do</span> <span style=color:#8be9fd;font-style:italic>it</span> <span style=color:#8be9fd;font-style:italic>after</span> <span style=color:#8be9fd;font-style:italic>formatting</span>
</span></span><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Display</span> <span style=color:#8be9fd;font-style:italic>reserved</span> <span style=color:#8be9fd;font-style:italic>space</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>tune2fs</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>l</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#ff79c6>|</span> <span style=color:#8be9fd;font-style:italic>grep</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>E</span> <span style=color:#f1fa8c>&#34;Reserved block count|Block size&#34;</span> <span style=color:#ff79c6>|</span> <span style=color:#8be9fd;font-style:italic>paste</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>sd</span><span style=color:#ff79c6>\</span> <span style=color:#ff79c6>|</span> <span style=color:#8be9fd;font-style:italic>awk</span> <span style=color:#6272a4>&#39;{print ($4 * $7 / ( 1024 * 1024 ) ), &#34;MiB&#34;}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>2048</span> <span style=color:#8be9fd;font-style:italic>MiB</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Get</span> <span style=color:#8be9fd;font-style:italic>block</span> <span style=color:#8be9fd;font-style:italic>size</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>tune2fs</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>l</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>data</span> <span style=color:#ff79c6>|</span> <span style=color:#8be9fd;font-style:italic>grep</span> <span style=color:#6272a4>&#39;Block size:&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Tweak</span> <span style=color:#8be9fd;font-style:italic>it</span> <span style=color:#8be9fd;font-style:italic>with</span> <span style=color:#8be9fd;font-style:italic>gigs</span> <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>1024</span><span style=color:#ff79c6>^</span><span style=color:#bd93f9>3</span> <span style=color:#ff79c6>/</span> <span style=color:#8be9fd;font-style:italic>block</span> <span style=color:#8be9fd;font-style:italic>size</span> (<span style=color:#bd93f9>4096</span> <span style=color:#8be9fd;font-style:italic>usually</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>tune2fs</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>r</span> <span style=color:#bd93f9>524288</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>media</span> </span></span></code></pre></div><p>Enable <code>fast_commit</code> <a href=#references>[6]</a>: <code>tune2fs -O fast_commit /dev/mapper/nvme-root</code> and verify.</p><h1 id=copy-data-to-ssd>Copy Data to SSD</h1><p>Boot into SystemRescue Live OS from a USB; I simply copied all files in its ISO to a FAT32 USB; UEFI boot simply looks for a <code>EFI</code> directory.
Label it <code>RESUCE1002</code> as the loader looks for a filesystem by this label to get its data once booted; without this you&rsquo;d still get a shell but
without much tools.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Mount</span> <span style=color:#8be9fd;font-style:italic>old</span> <span style=color:#8be9fd;font-style:italic>and</span> <span style=color:#8be9fd;font-style:italic>new</span> <span style=color:#8be9fd;font-style:italic>partitions</span> <span style=color:#8be9fd;font-style:italic>for</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>boot</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>efi</span>, <span style=color:#ff79c6>/</span> <span style=color:#8be9fd;font-style:italic>and</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>home</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mount</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>m</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>sda1</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>old</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>esp</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mount</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>m</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p1</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>new</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>esp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Sync:</span> <span style=color:#8be9fd;font-style:italic>mind</span> <span style=color:#8be9fd;font-style:italic>the</span> <span style=color:#8be9fd;font-style:italic>slash</span> <span style=color:#8be9fd;font-style:italic>and</span> <span style=color:#8be9fd;font-style:italic>the</span> <span style=color:#8be9fd;font-style:italic>lack</span> <span style=color:#8be9fd;font-style:italic>thereof</span>; <span style=color:#8be9fd;font-style:italic>we</span> <span style=color:#8be9fd;font-style:italic>want</span> <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>copy</span> <span style=color:#8be9fd;font-style:italic>the</span> <span style=color:#8be9fd;font-style:italic>contents</span> (<span style=color:#8be9fd;font-style:italic>not</span> <span style=color:#8be9fd;font-style:italic>the</span> <span style=color:#8be9fd;font-style:italic>directory</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>rsync</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>qaHAXS</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>old</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>root</span><span style=color:#ff79c6>/</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>new</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>root</span></span></span></code></pre></div><p>The parameters come from ArchWiki; refer <a href=#references>[7]</a>.</p><h1 id=fix-etcfstab>Fix <code>/etc/fstab</code></h1><p>Use <code>blkid</code> and fix UUIDs of new partitions. Using <code>genfstab</code> is an option but I fixed them manually.</p><h1 id=reinstall-grub>Reinstall GRUB</h1><p>Unmount everything</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>umount</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>old</span><span style=color:#ff79c6>/</span>{<span style=color:#8be9fd;font-style:italic>esp</span>,<span style=color:#8be9fd;font-style:italic>root</span>,<span style=color:#8be9fd;font-style:italic>home</span>}
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>umount</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>new</span><span style=color:#ff79c6>/</span>{<span style=color:#8be9fd;font-style:italic>esp</span>,<span style=color:#8be9fd;font-style:italic>root</span>,<span style=color:#8be9fd;font-style:italic>home</span>}
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>rmdir</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span>{<span style=color:#8be9fd;font-style:italic>old</span>,<span style=color:#8be9fd;font-style:italic>new</span>}</span></span></code></pre></div><p>Change root</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mount</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>m</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>root</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mount</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>m</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>home</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>home</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mount</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>m</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p1</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>boot</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>efi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>arch</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>chroot</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mnt</span></span></span></code></pre></div><p>Install GRUB; enable <code>lvm</code> and set <code>GRUB_DISABLE_OS_PROBER</code> as don&rsquo;t to probe and list old HDD&rsquo;s OSes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>grub</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>install</span> <span style=color:#ff79c6>--</span><span style=color:#8be9fd;font-style:italic>target</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>x86_64</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>efi</span> <span style=color:#ff79c6>--</span><span style=color:#8be9fd;font-style:italic>efi</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>directory</span><span style=color:#ff79c6>=/</span><span style=color:#8be9fd;font-style:italic>boot</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>efi</span> <span style=color:#ff79c6>--</span><span style=color:#8be9fd;font-style:italic>bootloader</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>GRUB</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># <span style=color:#8be9fd;font-style:italic>Add</span> `<span style=color:#8be9fd;font-style:italic>lvm</span>` <span style=color:#8be9fd;font-style:italic>to</span> <span style=color:#8be9fd;font-style:italic>GRUB_PRELOAD_MODULES</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nano</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>etc</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>default</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>grub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>grub</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>mkconfig</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>o</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>boot</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>grub</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>grub</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd;font-style:italic>cfg</span></span></span></code></pre></div><p>Regenerate initramfs image after adding <code>lvm2</code> to <code>HOOKS</code> in <code>/etc/mkinitcpio.conf</code> after <code>block</code> but before <code>filesystem</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>nano</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>etc</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mkinitcpio</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd;font-style:italic>conf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>mkinitcpio</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>p</span> <span style=color:#8be9fd;font-style:italic>linux</span></span></span></code></pre></div><h1 id=appendix-a-remove-stale-devmapper>Appendix A: Remove Stale <code>/dev/mapper/*</code></h1><p>Fixed partitioning (<code>fdisk</code>) first and logical partitioning (LVM) next; I forgot this basic rule and flipped the order.</p><p>It isn’t advised to go with no fixed partitions. <code>/boot/efi</code> is better off as a plain partition than a logical one
<a href=#references>[2]</a> and also some software might consider the device unpartitioned; risky <a href=#references>[1]</a>! This is about
reverting it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>lsblk</span> <span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>pf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>root</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>var</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>home</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>media</span>
</span></span><span style=display:flex><span>└─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>data</span></span></span></code></pre></div><p>showed this. I quickly partitioned the device (with <code>fdisk</code>) as <a href=https://en.wikipedia.org/wiki/GUID_Partition_Table>GPT</a> with two partitions assuming the LVM-stuff would
get overwritten. It did but I ended up with this zombie. Yikes!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>root</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>var</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>home</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>media</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>mapper</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme</span><span style=color:#ff79c6>-</span><span style=color:#8be9fd;font-style:italic>data</span>
</span></span><span style=display:flex><span>├─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p1</span>
</span></span><span style=display:flex><span>└─<span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1p2</span></span></span></code></pre></div><p>Removing the partition table didn’t fix anything other than dropping the last two entries. <code>pvs</code>, <code>vgs</code>, nor <code>lvs</code>
maintained that there’s nothing. The following low-level LVM command fixed the situation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-basic data-lang=basic><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>sudo</span> <span style=color:#8be9fd;font-style:italic>dd</span> <span style=color:#8be9fd;font-style:italic>if</span><span style=color:#ff79c6>=/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>zero</span> <span style=color:#8be9fd;font-style:italic>of</span><span style=color:#ff79c6>=/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>nvme0n1</span> <span style=color:#8be9fd;font-style:italic>bs</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>8</span><span style=color:#8be9fd;font-style:italic>K</span> <span style=color:#8be9fd;font-style:italic>count</span><span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span> <span style=color:#8be9fd;font-style:italic>oflag</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>direct</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>sudo</span> <span style=color:#8be9fd;font-style:italic>dmsetup</span> <span style=color:#8be9fd;font-style:italic>remove</span> <span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dev</span><span style=color:#ff79c6>/</span><span style=color:#8be9fd;font-style:italic>dm</span><span style=color:#ff79c6>-</span>{<span style=color:#bd93f9>0</span>,<span style=color:#bd93f9>1</span>,<span style=color:#bd93f9>2</span>,<span style=color:#bd93f9>3</span>,<span style=color:#bd93f9>4</span>}</span></span></code></pre></div><h1 id=references>References</h1><ol><li><a href=https://unix.stackexchange.com/questions/195643/is-fdisk-needed-with-lvm>Create partition table (<code>fdisk</code>) before LVM2</a></li><li><a href=https://www.baeldung.com/linux/lvm-boot-partition-recommendations>LVM Why Is It Not Recommended to Put the Boot Partition on LVM</a></li><li><a href=https://superuser.com/questions/1310927/what-is-the-absolute-minimum-size-a-uefi-system-partition-can-be>Absolute Minimum ESP Size</a></li><li><a href=https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux)>LVM - Wikipedia</a></li><li><a href=https://wiki.archlinux.org/title/Advanced_Format>Advanced Format - ArchWiki</a></li><li><a href=https://wiki.archlinux.org/title/Ext4>Ext4 - ArchWiki</a></li><li><a href=https://code.saghul.net/2022/12/migrating-an-archlinux-install-from-an-ssd-to-an-nvme-drive/>Migrating Arch from SSD to NVMe</a></li></ol><h1 id=see-also>See Also</h1><ol><li><a href=https://unix.stackexchange.com/questions/701200/move-var-and-home-directory-on-a-separate-nvme-partition>Move <code>/var</code> and <code>/home</code> to a separate NVME partition</a></li></ol><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>slang for motherboard&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/tags/tech/>tech</a>,
<a href=/tags/tools/>tools</a>,
<a href=/tags/linux/>linux</a></p><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Move%20Linux%20b%2fw%20Drives&url=https%3a%2f%2flegends2k.github.io%2fnote%2farch_hdd_nvme%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1' aria-label="Share on Twitter"><i class="fa fa-twitter" aria-hidden=true></i>
</a><a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2flegends2k.github.io%2fnote%2farch_hdd_nvme%2f" onclick='return window.open(this.href,"facebook-share","width=580,height=296"),!1' aria-label="Share on Facebook"><i class="fa fa-facebook" aria-hidden=true></i>
</a><a class=icon-linkedin href="https://www.linkedin.com/shareArticle?mini=true&title=Move%20Linux%20b%2fw%20Drives&url=https%3a%2f%2flegends2k.github.io%2fnote%2farch_hdd_nvme%2f&summary=From%20HDD%20to%20SSD" onclick='return window.open(this.href,"linkedin-share","width=554,height=481"),!1' aria-label="Share on LinkedIn"><i class="fa fa-linkedin" aria-hidden=true></i></a></div></footer></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a title="Bits of Insight" href=https://legends2k.github.io/><i class="fa fa-home"></i></a></h1><a class="button-square button-jump-top js-jump-top" href=#><i class="fa fa-angle-double-up"></i></a></div><p class=footer-copyright><a title="Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License" rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png></a></p><p class=footer-copyright><span>Rendered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span>Composed with <a href=https://www.gnu.org/software/emacs/>GNU Emacs</a></span></p><p class=footer-copyright>Occured to <a href></a></span></p></div></footer><script src=https://legends2k.github.io/js/jquery-1.11.3.min.js></script><script src=https://legends2k.github.io/js/jquery.fitvids.js></script><script src=https://legends2k.github.io/js/scripts.js></script></body></html>